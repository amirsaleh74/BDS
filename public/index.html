<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LOGIXX Dashboard - Automated Pipeline Management</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <!-- Login Modal -->
    <div id="loginModal" class="modal active">
        <div class="modal-content">
            <h2>üîê Dashboard Login</h2>
            <p>Enter password to access</p>
            <input type="password" id="loginPassword" placeholder="Enter password">
            <button onclick="login()" class="primary">Login</button>
            <div id="loginError" class="error-msg"></div>
        </div>
    </div>

    <!-- Logout Button -->
    <button id="logoutBtn" class="logout-btn" onclick="logout()" style="display:none;">Logout</button>

    <!-- Dashboard -->
    <div class="container" id="dashboardContent" style="display:none;">
        <!-- Header -->
        <div class="header">
            <h1>üéØ LOGIXX Pipeline Dashboard</h1>
            <p>Automated Scraping, Assignment & Management</p>
        </div>

        <!-- Stats -->
        <div class="stats-grid">
            <div class="stat-card">
                <h3>Total Leads</h3>
                <div class="number" id="totalFiles">0</div>
                <div class="label">Scraped</div>
            </div>
            <div class="stat-card">
                <h3>Assigned</h3>
                <div class="number" id="filesAssigned">0</div>
                <div class="label">To me</div>
            </div>
            <div class="stat-card">
                <h3>Activity</h3>
                <div class="number" id="totalActivity">0</div>
                <div class="label">Actions</div>
            </div>
            <div class="stat-card">
                <h3>Status</h3>
                <div class="status-text" id="currentStatus">Idle</div>
            </div>
        </div>

        <!-- Scraper Section -->
        <div class="section">
            <h2>üìä Pipeline Scraper</h2>
            <div class="form-group">
                <label>Number of pages to scrape (50 leads per page):</label>
                <input type="number" id="scrapePagesInput" value="1" min="1" max="50">
            </div>
            <div class="button-group">
                <button class="primary" onclick="startScraping()">üîÑ Start Scraping</button>
                <button class="success" onclick="exportToCSV()">üì• Export to CSV</button>
                <button class="secondary" onclick="viewData()">üëÅÔ∏è View Data</button>
                <button class="secondary" onclick="viewLogs()">üìã View Logs</button>
                <button class="secondary" onclick="downloadLogs()">‚¨áÔ∏è Download Logs</button>
            </div>
        </div>

        <!-- Settings Section -->
        <div class="section">
            <h2>‚öôÔ∏è Settings</h2>
            <div class="form-row">
                <div class="form-group">
                    <label>Logixx Email:</label>
                    <input type="text" id="settingsEmail" placeholder="your@email.com">
                </div>
                <div class="form-group">
                    <label>Logixx Password:</label>
                    <input type="password" id="settingsPassword" placeholder="Your password">
                </div>
            </div>
            <button class="primary" onclick="updateCredentials()">üíæ Update Credentials</button>
            <p style="color: #a0aec0; margin-top: 10px; font-size: 0.9em;">
                ‚ö†Ô∏è Note: Credentials are stored in memory only (not saved to database)
            </p>
        </div>

        <!-- Bulk Assignment -->
        <div class="section">
            <h2>‚ö° Bulk Lead Assignment</h2>
            <p>Assign multiple leads to yourself at once</p>
            <div class="form-group">
                <label>Enter App IDs (comma-separated):</label>
                <textarea id="assignAppIds" placeholder="e.g., 998815, 998742, 998740" rows="3"></textarea>
            </div>
            <button class="primary" onclick="assignLeads()">‚úÖ Assign Selected Leads to Me</button>
        </div>

        <!-- Schedule Callback -->
        <div class="section">
            <h2>üìÖ Schedule Callback</h2>
            <div class="form-row">
                <div class="form-group">
                    <label>App ID:</label>
                    <input type="text" id="callbackAppId" placeholder="e.g., 998815">
                </div>
                <div class="form-group">
                    <label>Title:</label>
                    <input type="text" id="callbackTitle" placeholder="e.g., FU">
                </div>
            </div>
            <div class="form-row">
                <div class="form-group">
                    <label>Description:</label>
                    <input type="text" id="callbackDescription" placeholder="Auto" value="Auto">
                </div>
                <div class="form-group">
                    <label>Event Time:</label>
                    <input type="datetime-local" id="callbackTime">
                </div>
            </div>
            <div class="form-group">
                <label>Duration:</label>
                <select id="callbackDuration">
                    <option value="5 Minutes" selected>5 Minutes</option>
                    <option value="10 Minutes">10 Minutes</option>
                    <option value="15 Minutes">15 Minutes</option>
                    <option value="30 Minutes">30 Minutes</option>
                    <option value="1 Hour">1 Hour</option>
                </select>
            </div>
            <button class="primary" onclick="scheduleCallback()">üìû Schedule Callback</button>
        </div>

        <!-- Add Note -->
        <div class="section">
            <h2>üìù Add Note to Lead</h2>
            <div class="form-group">
                <label>App ID:</label>
                <input type="text" id="noteAppId" placeholder="e.g., 998815">
            </div>
            <div class="form-group">
                <label>Note:</label>
                <textarea id="noteText" placeholder="Enter your note here..." rows="4"></textarea>
            </div>
            <button class="primary" onclick="addNote()">üí¨ Add Note</button>
        </div>

        <!-- Data Table -->
        <div class="section" id="dataSection" style="display:none;">
            <h2>üìã Scraped Data</h2>
            <div class="table-container">
                <table id="dataTable">
                    <thead id="tableHead"></thead>
                    <tbody id="tableBody"></tbody>
                </table>
            </div>
        </div>

        <!-- Logs Section -->
        <div class="section" id="logsSection" style="display:none;">
            <h2>üìã Recent Logs</h2>
            <div style="background: #1a202c; padding: 15px; border-radius: 6px; max-height: 400px; overflow-y: auto;">
                <pre id="logsDisplay" style="margin: 0; white-space: pre-wrap; word-wrap: break-word; font-size: 0.9em; color: #48bb78;"></pre>
            </div>
        </div>
    </div>

    <script>
        let eventSource = null;

        // Login
        async function login() {
            const password = document.getElementById('loginPassword').value;
            const errorDiv = document.getElementById('loginError');
            
            if (!password) {
                errorDiv.textContent = 'Please enter password';
                return;
            }

            try {
                const res = await fetch('/api/login', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ password })
                });

                if (res.ok) {
                    document.getElementById('loginModal').classList.remove('active');
                    document.getElementById('dashboardContent').style.display = 'block';
                    document.getElementById('logoutBtn').style.display = 'block';
                    setupLiveUpdates();
                } else {
                    errorDiv.textContent = 'Invalid password';
                }
            } catch (error) {
                errorDiv.textContent = 'Connection error';
            }
        }

        // Logout
        async function logout() {
            await fetch('/api/logout', { 
                method: 'POST',
                credentials: 'include'
            });
            if (eventSource) eventSource.close();
            location.reload();
        }

        // Live updates
        function setupLiveUpdates() {
            eventSource = new EventSource('/api/live-updates');
            
            eventSource.onmessage = (event) => {
                const data = JSON.parse(event.data);
                document.getElementById('totalFiles').textContent = data.totalFiles;
                document.getElementById('filesAssigned').textContent = data.filesAssigned;
                document.getElementById('totalActivity').textContent = data.totalActivity;
                document.getElementById('currentStatus').textContent = data.currentStatus;
            };

            eventSource.onerror = () => {
                eventSource.close();
                setTimeout(setupLiveUpdates, 5000);
            };
        }

        // Start scraping
        async function startScraping() {
            const pages = parseInt(document.getElementById('scrapePagesInput').value);
            
            if (!pages || pages < 1) {
                alert('Please enter valid number of pages');
                return;
            }

            try {
                const res = await fetch('/api/scraper/scrape', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    credentials: 'include',
                    body: JSON.stringify({ pages })
                });

                const data = await res.json();
                
                if (res.ok) {
                    alert(`‚úÖ Successfully scraped ${data.count} leads!`);
                    displayData(data.data);
                } else {
                    alert(`‚ùå Error: ${data.error}`);
                }
            } catch (error) {
                alert(`‚ùå Error: ${error.message}`);
            }
        }

        // Assign leads
        async function assignLeads() {
            const input = document.getElementById('assignAppIds').value.trim();
            
            if (!input) {
                alert('Please enter App IDs');
                return;
            }

            const appIds = input.split(',').map(id => id.trim()).filter(id => id);
            
            if (appIds.length === 0) {
                alert('No valid App IDs found');
                return;
            }

            if (!confirm(`Assign ${appIds.length} leads to yourself?`)) {
                return;
            }

            try {
                const res = await fetch('/api/scraper/assign-leads', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    credentials: 'include',
                    body: JSON.stringify({ appIds })
                });

                const data = await res.json();
                
                if (res.ok) {
                    alert(`‚úÖ Assigned ${data.results.successCount}/${appIds.length} leads!`);
                    document.getElementById('assignAppIds').value = '';
                } else {
                    alert(`‚ùå Error: ${data.error}`);
                }
            } catch (error) {
                alert(`‚ùå Error: ${error.message}`);
            }
        }

        // Schedule callback
        async function scheduleCallback() {
            const appId = document.getElementById('callbackAppId').value.trim();
            const title = document.getElementById('callbackTitle').value.trim();
            const description = document.getElementById('callbackDescription').value.trim();
            const eventTime = document.getElementById('callbackTime').value;
            const duration = document.getElementById('callbackDuration').value;
            
            if (!appId || !title || !eventTime) {
                alert('Please fill App ID, Title, and Event Time');
                return;
            }

            try {
                const res = await fetch('/api/scraper/schedule-callback', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    credentials: 'include',
                    body: JSON.stringify({ appId, title, description, eventTime, duration })
                });

                if (res.ok) {
                    alert('‚úÖ Callback scheduled successfully!');
                    document.getElementById('callbackAppId').value = '';
                    document.getElementById('callbackTitle').value = '';
                } else {
                    const data = await res.json();
                    alert(`‚ùå Error: ${data.error}`);
                }
            } catch (error) {
                alert(`‚ùå Error: ${error.message}`);
            }
        }

        // Add note
        async function addNote() {
            const appId = document.getElementById('noteAppId').value.trim();
            const note = document.getElementById('noteText').value.trim();
            
            if (!appId || !note) {
                alert('Please fill App ID and Note');
                return;
            }

            try {
                const res = await fetch('/api/scraper/add-note', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    credentials: 'include',
                    body: JSON.stringify({ appId, note })
                });

                if (res.ok) {
                    alert('‚úÖ Note added successfully!');
                    document.getElementById('noteAppId').value = '';
                    document.getElementById('noteText').value = '';
                } else {
                    const data = await res.json();
                    alert(`‚ùå Error: ${data.error}`);
                }
            } catch (error) {
                alert(`‚ùå Error: ${error.message}`);
            }
        }

        // Export CSV
        async function exportToCSV() {
            try {
                const res = await fetch('/api/export-csv', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    credentials: 'include'
                });

                if (res.ok) {
                    const blob = await res.blob();
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `logixx-export-${Date.now()}.csv`;
                    a.click();
                } else {
                    const data = await res.json();
                    alert(`‚ùå ${data.error}`);
                }
            } catch (error) {
                alert(`‚ùå Error: ${error.message}`);
            }
        }

        // View data
        async function viewData() {
            try {
                const res = await fetch('/api/scraper/data', {
                    credentials: 'include'
                });
                const data = await res.json();
                
                if (data.data && data.data.length > 0) {
                    displayData(data.data);
                } else {
                    alert('No data available. Run scraper first!');
                }
            } catch (error) {
                alert(`‚ùå Error: ${error.message}`);
            }
        }

        // View logs
        async function viewLogs() {
            try {
                const res = await fetch('/api/logs/latest', {
                    credentials: 'include'
                });
                
                if (res.ok) {
                    const data = await res.json();
                    const logs = data.logs || data.buffer || 'No logs available';
                    
                    // Show inline
                    const logsSection = document.getElementById('logsSection');
                    const logsDisplay = document.getElementById('logsDisplay');
                    logsDisplay.textContent = logs;
                    logsSection.style.display = 'block';
                    logsSection.scrollIntoView({ behavior: 'smooth' });
                } else {
                    alert('‚ùå No logs available yet. Run scraper first!');
                }
            } catch (error) {
                alert(`‚ùå Error: ${error.message}`);
            }
        }

        // Download logs
        async function downloadLogs() {
            try {
                const res = await fetch('/api/logs/download', {
                    credentials: 'include'
                });
                
                if (res.ok) {
                    const blob = await res.blob();
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `logixx-scraper-${Date.now()}.log`;
                    a.click();
                } else {
                    alert('‚ùå No logs available yet. Run scraper first!');
                }
            } catch (error) {
                alert(`‚ùå Error: ${error.message}`);
            }
        }

        // Update credentials
        async function updateCredentials() {
            const email = document.getElementById('settingsEmail').value.trim();
            const password = document.getElementById('settingsPassword').value.trim();
            
            if (!email && !password) {
                alert('Please enter at least email or password');
                return;
            }

            if (!confirm('Update Logixx credentials? This will be used for next scrape.')) {
                return;
            }

            try {
                const res = await fetch('/api/settings/credentials', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    credentials: 'include',
                    body: JSON.stringify({ email, password })
                });

                const data = await res.json();
                
                if (res.ok) {
                    alert('‚úÖ Credentials updated! Next scrape will use new credentials.');
                    document.getElementById('settingsEmail').value = '';
                    document.getElementById('settingsPassword').value = '';
                } else {
                    alert(`‚ùå Error: ${data.error}`);
                }
            } catch (error) {
                alert(`‚ùå Error: ${error.message}`);
            }
        }

        // Display data in table
        function displayData(data) {
            if (!data || data.length === 0) return;
            
            const section = document.getElementById('dataSection');
            const thead = document.getElementById('tableHead');
            const tbody = document.getElementById('tableBody');
            
            // Build headers
            const headers = Object.keys(data[0]);
            thead.innerHTML = '<tr>' + headers.map(h => `<th>${h}</th>`).join('') + '</tr>';
            
            // Build rows
            tbody.innerHTML = data.map(row => 
                '<tr>' + headers.map(h => `<td>${row[h] || ''}</td>`).join('') + '</tr>'
            ).join('');
            
            section.style.display = 'block';
            section.scrollIntoView({ behavior: 'smooth' });
        }

        // Enter to login
        document.addEventListener('DOMContentLoaded', () => {
            document.getElementById('loginPassword').addEventListener('keypress', (e) => {
                if (e.key === 'Enter') login();
            });
        });
    </script>
</body>
</html>
