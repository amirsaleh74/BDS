<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LOGIXX Dashboard - Manual Login</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <!-- Login Modal -->
    <div id="loginModal" class="modal active">
        <div class="modal-content">
            <h2>üîê Dashboard Login</h2>
            <input type="password" id="loginPassword" placeholder="Enter password">
            <button onclick="login()" class="primary">Login</button>
            <div id="loginError" class="error-msg"></div>
        </div>
    </div>

    <!-- Logout Button -->
    <button id="logoutBtn" class="logout-btn" onclick="logout()" style="display:none;">Logout</button>

    <!-- Dashboard -->
    <div class="container" id="dashboardContent" style="display:none;">
        <div class="header">
            <h1>üéØ LOGIXX Pipeline Dashboard</h1>
            <p>Manual Login + Automated Scraping</p>
        </div>

        <!-- Stats -->
        <div class="stats-grid">
            <div class="stat-card">
                <h3>Total Leads</h3>
                <div class="number" id="totalFiles">0</div>
                <div class="label" id="dataSource">Memory</div>
            </div>
            <div class="stat-card">
                <h3>Activity</h3>
                <div class="number" id="totalActivity">0</div>
            </div>
            <div class="stat-card">
                <h3>Session Status</h3>
                <div class="status-text" id="sessionStatus">Not Logged In</div>
            </div>
            <div class="stat-card">
                <h3>Scraper Status</h3>
                <div class="status-text" id="currentStatus">Idle</div>
            </div>
        </div>

        <!-- Manual Login Section -->
        <div class="section" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border: 2px solid #667eea;">
            <h2 style="color: white;">üîë Step 1: Login to Logixx</h2>
            <p style="color: #e2e8f0; margin-bottom: 20px;">
                You need to login to Logixx manually. Click the button below to open Logixx in a new window.
            </p>
            <button class="primary" onclick="openLogixxLogin()" style="font-size: 1.1em; padding: 15px 30px;">
                üåê Open Logixx Login Page
            </button>
            <div id="loginInstructions" style="display:none; margin-top: 20px; background: rgba(0,0,0,0.3); padding: 20px; border-radius: 8px;">
                <h3 style="color: white;">üìã After you login to Logixx:</h3>
                <ol style="color: #e2e8f0; line-height: 1.8;">
                    <li>Press <kbd style="background: #1a202c; padding: 3px 8px; border-radius: 4px;">F12</kbd> to open Developer Tools</li>
                    <li>Go to the <strong>Console</strong> tab</li>
                    <li>Paste this code and press Enter:</li>
                </ol>
                <div style="background: #1a202c; padding: 15px; border-radius: 6px; margin: 10px 0; overflow-x: auto;">
                    <code style="color: #48bb78; font-family: monospace; font-size: 0.9em;" id="cookieScript">
copy(JSON.stringify(document.cookie.split('; ').map(c => {
    const [name, value] = c.split('=');
    return {name, value, domain: '.logixx.io', path: '/'};
})))
                    </code>
                </div>
                <ol start="4" style="color: #e2e8f0; line-height: 1.8;">
                    <li>The cookies are now copied to your clipboard</li>
                    <li>Come back here and paste them below:</li>
                </ol>
                <textarea id="cookiesInput" placeholder="Paste cookies here..." rows="4" style="width: 100%; margin: 10px 0; font-family: monospace;"></textarea>
                <button class="success" onclick="saveCookies()" style="width: 100%;">
                    ‚úÖ Save Cookies & Start Scraping
                </button>
            </div>
        </div>

        <!-- Scraper Section -->
        <div class="section">
            <h2>üìä Step 2: Scrape Pipeline</h2>
            <div id="scraperDisabled" style="padding: 15px; background: #4a5568; border-radius: 6px; margin-bottom: 15px;">
                <p style="color: #e2e8f0; margin: 0;">‚ö†Ô∏è Please login to Logixx first using the button above</p>
            </div>
            <div id="scraperEnabled" style="display: none;">
                <div class="form-group">
                    <label>Number of pages (50 leads per page):</label>
                    <input type="number" id="scrapePagesInput" value="1" min="1" max="50">
                </div>
                <div class="button-group">
                    <button class="primary" onclick="startScraping()">üîÑ Start Scraping</button>
                    <button class="success" onclick="exportToCSV()">üì• Export CSV</button>
                    <button class="secondary" onclick="viewData()">üëÅÔ∏è View Data</button>
                </div>
            </div>
        </div>

        <!-- Data Table -->
        <div class="section" id="dataSection" style="display:none;">
            <h2>üìã Scraped Data</h2>
            <div class="table-container">
                <table id="dataTable">
                    <thead id="tableHead"></thead>
                    <tbody id="tableBody"></tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
        let eventSource = null;
        let logixxWindow = null;

        // Login to dashboard
        async function login() {
            const password = document.getElementById('loginPassword').value;
            const errorDiv = document.getElementById('loginError');
            
            if (!password) {
                errorDiv.textContent = 'Please enter password';
                return;
            }

            try {
                const res = await fetch('/api/login', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ password })
                });

                if (res.ok) {
                    document.getElementById('loginModal').classList.remove('active');
                    document.getElementById('dashboardContent').style.display = 'block';
                    document.getElementById('logoutBtn').style.display = 'block';
                    setupLiveUpdates();
                    checkSessionStatus();
                } else {
                    errorDiv.textContent = 'Invalid password';
                }
            } catch (error) {
                errorDiv.textContent = 'Connection error';
            }
        }

        // Logout
        async function logout() {
            await fetch('/api/logout', { method: 'POST', credentials: 'include' });
            if (eventSource) eventSource.close();
            location.reload();
        }

        // Live updates
        function setupLiveUpdates() {
            eventSource = new EventSource('/api/live-updates');
            
            eventSource.onmessage = (event) => {
                const data = JSON.parse(event.data);
                document.getElementById('totalFiles').textContent = data.totalFiles;
                document.getElementById('totalActivity').textContent = data.totalActivity;
                document.getElementById('currentStatus').textContent = data.currentStatus;
                
                if (data.sessionValid) {
                    document.getElementById('sessionStatus').textContent = '‚úÖ Logged In';
                    document.getElementById('sessionStatus').style.color = '#48bb78';
                    document.getElementById('scraperDisabled').style.display = 'none';
                    document.getElementById('scraperEnabled').style.display = 'block';
                } else {
                    document.getElementById('sessionStatus').textContent = '‚ùå Not Logged In';
                    document.getElementById('sessionStatus').style.color = '#f56565';
                }
            };
        }

        // Check session status
        async function checkSessionStatus() {
            try {
                const res = await fetch('/api/logixx/status', { credentials: 'include' });
                const data = await res.json();
                
                if (data.hasSession) {
                    document.getElementById('scraperDisabled').style.display = 'none';
                    document.getElementById('scraperEnabled').style.display = 'block';
                    document.getElementById('sessionStatus').textContent = '‚úÖ Logged In';
                    document.getElementById('sessionStatus').style.color = '#48bb78';
                }
            } catch (error) {
                console.error('Status check failed:', error);
            }
            
            // Check database status
            try {
                const res = await fetch('/health');
                const data = await res.json();
                if (data.database === 'connected') {
                    document.getElementById('dataSource').textContent = 'üíæ Database';
                    document.getElementById('dataSource').style.color = '#48bb78';
                } else {
                    document.getElementById('dataSource').textContent = '‚ö†Ô∏è Memory';
                    document.getElementById('dataSource').style.color = '#f59e0b';
                }
            } catch (error) {
                console.error('Health check failed:', error);
            }
        }

        // Open Logixx login
        function openLogixxLogin() {
            logixxWindow = window.open('https://bds.logixx.io/auth/sign-in', 'LogixxLogin', 'width=800,height=600');
            document.getElementById('loginInstructions').style.display = 'block';
            
            // Check if window is still open
            const checkWindow = setInterval(() => {
                if (logixxWindow && logixxWindow.closed) {
                    clearInterval(checkWindow);
                    alert('Logixx window closed. Did you copy the cookies?');
                }
            }, 1000);
        }

        // Save cookies
        async function saveCookies() {
            const cookiesText = document.getElementById('cookiesInput').value.trim();
            
            if (!cookiesText) {
                alert('Please paste the cookies first!');
                return;
            }

            try {
                const cookies = JSON.parse(cookiesText);
                
                if (!Array.isArray(cookies)) {
                    throw new Error('Invalid format');
                }

                const res = await fetch('/api/logixx/save-cookies', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    credentials: 'include',
                    body: JSON.stringify({ cookies })
                });

                const data = await res.json();
                
                if (res.ok) {
                    alert(`‚úÖ Success! Saved ${data.count} cookies. You can now scrape!`);
                    document.getElementById('cookiesInput').value = '';
                    document.getElementById('scraperDisabled').style.display = 'none';
                    document.getElementById('scraperEnabled').style.display = 'block';
                    document.getElementById('sessionStatus').textContent = '‚úÖ Logged In';
                } else {
                    alert(`‚ùå Error: ${data.error}`);
                }
            } catch (error) {
                alert(`‚ùå Invalid cookies format. Make sure you pasted the output from the console.`);
            }
        }

        // Start scraping
        async function startScraping() {
            const pages = parseInt(document.getElementById('scrapePagesInput').value);
            
            if (!pages || pages < 1) {
                alert('Enter valid number of pages');
                return;
            }

            try {
                const res = await fetch('/api/scraper/scrape', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    credentials: 'include',
                    body: JSON.stringify({ pages })
                });

                const data = await res.json();
                
                if (res.ok) {
                    alert(`‚úÖ Scraped ${data.count} leads!`);
                    displayData(data.data);
                } else {
                    if (data.error.includes('login')) {
                        alert('‚ùå Session expired! Please login to Logixx again.');
                        document.getElementById('scraperEnabled').style.display = 'none';
                        document.getElementById('scraperDisabled').style.display = 'block';
                    } else {
                        alert(`‚ùå Error: ${data.error}`);
                    }
                }
            } catch (error) {
                alert(`‚ùå Error: ${error.message}`);
            }
        }

        // Export CSV
        async function exportToCSV() {
            try {
                const res = await fetch('/api/export-csv', {
                    method: 'POST',
                    credentials: 'include'
                });

                if (res.ok) {
                    const blob = await res.blob();
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `logixx-${Date.now()}.csv`;
                    a.click();
                } else {
                    const data = await res.json();
                    alert(`‚ùå ${data.error}`);
                }
            } catch (error) {
                alert(`‚ùå Error: ${error.message}`);
            }
        }

        // View data
        async function viewData() {
            try {
                const res = await fetch('/api/scraper/data', { credentials: 'include' });
                const result = await res.json();
                
                if (result.data && result.data.length > 0) {
                    displayData(result.data);
                    const source = result.source === 'database' ? 'üíæ Database' : '‚ö†Ô∏è Memory';
                    alert(`Showing ${result.count} leads from ${source}`);
                } else {
                    alert('No data. Run scraper first!');
                }
            } catch (error) {
                alert(`‚ùå Error: ${error.message}`);
            }
        }

        // Display data
        function displayData(data) {
            if (!data || data.length === 0) return;
            
            const section = document.getElementById('dataSection');
            const thead = document.getElementById('tableHead');
            const tbody = document.getElementById('tableBody');
            
            const headers = Object.keys(data[0]);
            thead.innerHTML = '<tr>' + headers.map(h => `<th>${h}</th>`).join('') + '</tr>';
            
            tbody.innerHTML = data.map(row => 
                '<tr>' + headers.map(h => `<td>${row[h] || ''}</td>`).join('') + '</tr>'
            ).join('');
            
            section.style.display = 'block';
            section.scrollIntoView({ behavior: 'smooth' });
        }

        // Enter to login
        document.addEventListener('DOMContentLoaded', () => {
            document.getElementById('loginPassword').addEventListener('keypress', (e) => {
                if (e.key === 'Enter') login();
            });
        });
    </script>
</body>
</html>
